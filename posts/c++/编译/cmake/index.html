<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <meta name="author" content="Zhengyu Chen">
    <meta name="description" content="ZintrulCre @ 尾張">
    <meta name="keywords" content="ZintrulCre, 尾張">

    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="CMake 入门"/>
<meta name="twitter:description" content="CMake 入门 0. 序 CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。 1. 构建单个文件 1.1 使用"/>

    <meta property="og:title" content="CMake 入门" />
<meta property="og:description" content="CMake 入门 0. 序 CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。 1. 构建单个文件 1.1 使用" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://zintrulcre.vip/posts/c&#43;&#43;/%E7%BC%96%E8%AF%91/cmake/" />
<meta property="article:published_time" content="2020-06-21T15:46:06+08:00" />
<meta property="article:modified_time" content="2020-06-21T15:46:06+08:00" />


    
      <base href="https://zintrulcre.vip/posts/c&#43;&#43;/%E7%BC%96%E8%AF%91/cmake/">
    
    <title>
  CMake 入门 · 尾張
</title>

    
      <link rel="canonical" href="https://zintrulcre.vip/posts/c&#43;&#43;/%E7%BC%96%E8%AF%91/cmake/">
    

    <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CMerriweather:300,700%7CSource+Code+Pro:400,700" rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU" crossorigin="anonymous" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" integrity="sha256-oSrCnRYXvHG31SBifqP2PM1uje7SJUyX0nTwO2RJV54=" crossorigin="anonymous" />

    
      
      
      <link rel="stylesheet" href="https://zintrulcre.vip/css/coder.min.28d751104f30c16da1aa1bb04015cbe662cacfe0d1b01af4f2240ad58580069c.css" integrity="sha256-KNdREE8wwW2hqhuwQBXL5mLKz&#43;DRsBr08iQK1YWABpw=" crossorigin="anonymous" media="screen" />
    

    

    

    

    <link rel="icon" type="image/png" href="https://zintrulcre.vip/images/favicon-32x32.png" sizes="32x32">
    <link rel="icon" type="image/png" href="https://zintrulcre.vip/images/favicon-16x16.png" sizes="16x16">

    <meta name="generator" content="Hugo 0.75.1" />
  </head>

  <body class=" ">
    <main class="wrapper">
      <nav class="navigation">
  <section class="container">
    <a class="navigation-title" href="https://zintrulcre.vip">
      尾張
    </a>
    <input type="checkbox" id="menu-toggle" />
    <label class="menu-button float-right" for="menu-toggle"><i class="fas fa-bars"></i></label>
    <ul class="navigation-list">
      
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://zintrulcre.vip/posts/">Posts</a>
          </li>
        
          <li class="navigation-item">
            <a class="navigation-link" href="https://zintrulcre.vip/about/">About</a>
          </li>
        
      
      
    </ul>
  </section>
</nav>


      <div class="content">
        
  <section class="container post">
    <article>
      <header>
        <div class="post-title">
          <h1 class="title">CMake 入门</h1>
        </div>
        <div class="post-meta">
          <div class="date">
            <span class="posted-on">
              <i class="fas fa-calendar"></i>
              <time datetime='2020-06-21T15:46:06&#43;08:00'>
                June 21, 2020
              </time>
            </span>
            
          </div>
          <div class="categories">
  <i class="fas fa-folder"></i>
    <a href="https://zintrulcre.vip/categories/c&#43;&#43;/">C&#43;&#43;</a></div>

          
        </div>
      </header>

      <div>
        <h1 id="cmake-入门">CMake 入门</h1>
<h2 id="0-序">0. 序</h2>
<p>CMake 是一个跨平台的开源构建工具，使用 CMake 能够方便地管理依赖多个库的目录层次结构并生成 makefile 和使用 GNU make 来编译和连接程序。</p>
<h2 id="1-构建单个文件">1. 构建单个文件</h2>
<h3 id="11-使用-gcc-编译">1.1 使用 GCC 编译</h3>
<p>假设现在我们希望编写一个函数来实现安全的 int 类型加法防止数据溢出，这个源文件没有任何依赖的源码或静态库：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007f7f">// safe_add.cpp
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;iostream&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;memory&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#define INT_MAX 2147483647
</span><span style="color:#0f0;font-weight:bold">#define ERROR_DATA_OVERFLOW 2
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">int</span> SafeIntAdd(std::unique_ptr&lt;<span style="color:#fff;font-weight:bold">int</span>&gt; &amp;sum, <span style="color:#fff;font-weight:bold">int</span> a, <span style="color:#fff;font-weight:bold">int</span> b)
{
    <span style="color:#fff;font-weight:bold">if</span> (a &gt; INT_MAX - b)
    {
        *sum = INT_MAX;
        <span style="color:#fff;font-weight:bold">return</span> ERROR_DATA_OVERFLOW;
    }
    *sum = a + b;
    <span style="color:#fff;font-weight:bold">return</span> EXIT_SUCCESS;
}

<span style="color:#fff;font-weight:bold">int</span> main()
{
    <span style="color:#fff;font-weight:bold">int</span> a, b;
    std::cin &gt;&gt; a &gt;&gt; b;
    std::unique_ptr&lt;<span style="color:#fff;font-weight:bold">int</span>&gt; sum(<span style="color:#fff;font-weight:bold">new</span> <span style="color:#fff;font-weight:bold">int</span>(<span style="color:#ff0;font-weight:bold">1</span>));
    <span style="color:#fff;font-weight:bold">int</span> res = SafeIntAdd(sum, a, b);
    std::cout &lt;&lt; *sum &lt;&lt; std::endl;
    <span style="color:#fff;font-weight:bold">return</span> res;
}

</code></pre></div><p>我们可以直接使用一句简单的 gcc 命令来编译这个文件并执行：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial]$ g++ main.cc -g -Wall -std=c++11 -o SafeIntAdd
[joelzychen@DevCloud ~/cmake-tutorial]$ ./SafeIntAdd 
<span style="color:#ff0;font-weight:bold">2100000000</span> <span style="color:#ff0;font-weight:bold">2100000000</span>
<span style="color:#ff0;font-weight:bold">2147483647</span>
</code></pre></div><h3 id="12-使用-cmake-构建">1.2 使用 cmake 构建</h3>
<p>如果要使用 cmake 来生成 makefile 的话我们需要首先新建一个 CMakeLists.txt 文件，cmake 的所有配置都在这个文件中完成，CMakeLists.txt 中的内容大致如下：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#fff;font-weight:bold">cmake_minimum_required</span>(<span style="color:#0ff;font-weight:bold">VERSION</span> <span style="color:#0ff;font-weight:bold">3.10</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">project</span>(<span style="color:#0ff;font-weight:bold">SafeIntAdd</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_COMPILER</span> <span style="color:#0ff;font-weight:bold">&#34;c++&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD</span> <span style="color:#0ff;font-weight:bold">11</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#0ff;font-weight:bold">True</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">-g</span> <span style="color:#0ff;font-weight:bold">-Wall</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;CMAKE_CXX_FLAGS: &#34;</span> <span style="color:#0ff;font-weight:bold">&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">string</span>(<span style="color:#0ff;font-weight:bold">REPLACE</span> <span style="color:#0ff;font-weight:bold">&#34;;&#34;</span> <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> <span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;CMAKE_CXX_FLAGS: &#34;</span> <span style="color:#0ff;font-weight:bold">&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">add_executable</span>(<span style="color:#0ff;font-weight:bold">SafeIntAdd</span> <span style="color:#0ff;font-weight:bold">main.cc</span>)<span style="color:#f00">
</span></code></pre></div><p>其中有一些基础的 cmake 指令，它们的含义如下：</p>
<ol>
<li>cmake_minimum_required：cmake 的最低版本要求</li>
<li>project：指定项目的名称</li>
<li>set：设置普通变量，缓存变量或环境变量，上面例子中的</li>
<li>add_executable：使用列出的源文件构建可执行文件</li>
</ol>
<p>有几个需要注意的点：</p>
<ol>
<li>
<p>cmake 的指令是不区分大小写的，写作 CMAKE_MINIMUM_REQUIRED 或 cmake_minimum_required，甚至是 cmAkE_mInImUm_rEquIrEd（不建议）都是可以的</p>
</li>
<li>
<p>在使用 set 指令指定 CMAKE_CXX_FLAGS 的时候通过空格来分隔多个编译选项，生成的 CMAKE_CXX_FLAGS 字符串是 &ldquo;-g;-Wall&rdquo;，需要用字符串替换将分号替换为空格</p>
</li>
<li>
<p>message 可以在构建的过程中向 stdout 输出一些信息，上面例子中的输出信息为：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">-- CMAKE_CXX_FLAGS: -g;-Wall
-- CMAKE_CXX_FLAGS: -g -Wall
</code></pre></div></li>
<li>
<p>类似于 bash 脚本，在 CMakeLists.txt 中输出变量时要使用 &ldquo;${CMAKE_CXX_FLAGS}&rdquo; 的形式，而不能直接使用 CMAKE_CXX_FLAGS</p>
</li>
</ol>
<p>编辑好 CMakeLists.txt 之后，我们可以新建一个 build 目录，并在 build 目录下使用 cmake 来进行构建，构建成功的话再使用 make 来进行编译和链接，最终得到 SafeAdd 这个可执行文件：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial]$ mkdir build/
[joelzychen@DevCloud ~/cmake-tutorial]$ <span style="color:#fff;font-weight:bold">cd</span> build/
[joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ..
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style="color:#fff;font-weight:bold">done</span>
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style="color:#fff;font-weight:bold">done</span>
-- CMAKE_CXX_FLAGS: -g;-Wall
-- CMAKE_CXX_FLAGS: -g -Wall
-- Configuring <span style="color:#fff;font-weight:bold">done</span>
-- Generating <span style="color:#fff;font-weight:bold">done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
[joelzychen@DevCloud ~/cmake-tutorial/build]$ make
Scanning dependencies of target SafeIntAdd
[ 50%] Building CXX object CMakeFiles/SafeIntAdd.dir/main.cc.o
[100%] Linking CXX executable SafeIntAdd
[100%] Built target SafeIntAdd
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ./SafeIntAdd 
<span style="color:#ff0;font-weight:bold">2100000000</span> <span style="color:#ff0;font-weight:bold">2100000000</span>
<span style="color:#ff0;font-weight:bold">2147483647</span>
</code></pre></div><h2 id="2-构建多个文件">2. 构建多个文件</h2>
<h3 id="21-使用-gcc-编译">2.1 使用 GCC 编译</h3>
<p>假设现在我们希望将加法函数放到单独的文件中去，并在 main 函数所在的源文件中包含这个文件：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007f7f">// main.cc
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;math.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;error_code.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;iostream&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">int</span> main()
{
    <span style="color:#fff;font-weight:bold">int</span> a{ <span style="color:#ff0;font-weight:bold">0</span> }, b{ <span style="color:#ff0;font-weight:bold">0</span> }, c{ <span style="color:#ff0;font-weight:bold">0</span> };
    std::cin &gt;&gt; a &gt;&gt; b &gt;&gt; c;
    <span style="color:#fff;font-weight:bold">int</span> sum{ <span style="color:#ff0;font-weight:bold">0</span> };
    <span style="color:#fff;font-weight:bold">int</span> ret_val = SafeAdd(sum, a, b, c);
    std::cout &lt;&lt; sum &lt;&lt; std::endl;
    <span style="color:#fff;font-weight:bold">return</span> ret_val;
}

</code></pre></div><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007f7f">// util/math.h
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#ifndef UTIL_MATH_H
</span><span style="color:#0f0;font-weight:bold">#define UTIL_MATH_H
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;error_code.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;limits&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">template</span>&lt;<span style="color:#fff;font-weight:bold">typename</span> ValueType&gt;
ValueType ValueTypeMax(ValueType)
{
    <span style="color:#fff;font-weight:bold">return</span> std::numeric_limits&lt;ValueType&gt;::max();
}

<span style="color:#fff;font-weight:bold">template</span>&lt;<span style="color:#fff;font-weight:bold">typename</span> ValueType&gt;
<span style="color:#fff;font-weight:bold">int</span> SafeAdd(ValueType &amp;sum)
{
    <span style="color:#fff;font-weight:bold">return</span> exit_success;
}

<span style="color:#fff;font-weight:bold">template</span>&lt;<span style="color:#fff;font-weight:bold">typename</span> ValueType, <span style="color:#fff;font-weight:bold">typename</span> ...ValueTypes&gt;
<span style="color:#fff;font-weight:bold">int</span> SafeAdd(ValueType &amp;sum, <span style="color:#fff;font-weight:bold">const</span> ValueType &amp;value, <span style="color:#fff;font-weight:bold">const</span> ValueTypes &amp;...other_values)
{
    <span style="color:#fff;font-weight:bold">int</span> ret_val = SafeAdd&lt;ValueType&gt;(sum, other_values...);
    <span style="color:#fff;font-weight:bold">if</span> (ret_val != exit_success)
    {
        <span style="color:#fff;font-weight:bold">return</span> ret_val;
    }
    <span style="color:#fff;font-weight:bold">if</span> (sum &gt; ValueTypeMax(value) - value)
    {
        sum = ValueTypeMax(value);
        <span style="color:#fff;font-weight:bold">return</span> error_data_overflow;
    }
    sum += value;
    <span style="color:#fff;font-weight:bold">return</span> exit_success;
}

<span style="color:#0f0;font-weight:bold">#endif
</span></code></pre></div><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007f7f">// definition/error_code.h
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#ifndef DEFINITION_ERROR_CODE_H
</span><span style="color:#0f0;font-weight:bold">#define DEFINITION_ERROR_CODE_H
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">constexpr</span> <span style="color:#fff;font-weight:bold">int</span> exit_success = <span style="color:#ff0;font-weight:bold">0</span>;
<span style="color:#fff;font-weight:bold">constexpr</span> <span style="color:#fff;font-weight:bold">int</span> exit_failure = <span style="color:#ff0;font-weight:bold">1</span>;
<span style="color:#fff;font-weight:bold">constexpr</span> <span style="color:#fff;font-weight:bold">int</span> error_data_overflow = <span style="color:#ff0;font-weight:bold">2</span>;

<span style="color:#0f0;font-weight:bold">#endif
</span></code></pre></div><p>我们可以在使用 GCC 编译的时候使用 -I 参数指定头文件所在的目录：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/safe_add]$ g++ -g -Wall -std=c++11 -Ilib -Idefinition -o SafeAdd main.cc
[joelzychen@DevCloud ~/safe_add]$ ./SafeAdd
<span style="color:#ff0;font-weight:bold">20000</span> <span style="color:#ff0;font-weight:bold">50000</span> <span style="color:#ff0;font-weight:bold">80000</span>
<span style="color:#ff0;font-weight:bold">150000</span>
</code></pre></div><h3 id="22-使用-cmake-构建">2.2 使用 cmake 构建</h3>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#fff;font-weight:bold">cmake_minimum_required</span>(<span style="color:#0ff;font-weight:bold">VERSION</span> <span style="color:#0ff;font-weight:bold">3.10</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">project</span>(<span style="color:#0ff;font-weight:bold">SafeIntAdd</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_COMPILER</span> <span style="color:#0ff;font-weight:bold">&#34;c++&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD</span> <span style="color:#0ff;font-weight:bold">11</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#0ff;font-weight:bold">True</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">-g</span> <span style="color:#0ff;font-weight:bold">-Wall</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">string</span>(<span style="color:#0ff;font-weight:bold">REPLACE</span> <span style="color:#0ff;font-weight:bold">&#34;;&#34;</span> <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> <span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">include_directories</span>(<span style="color:#0ff;font-weight:bold">lib/</span> <span style="color:#0ff;font-weight:bold">definition/</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">aux_source_directory</span>(<span style="color:#0ff;font-weight:bold">./</span> <span style="color:#0ff;font-weight:bold">SOURCE_DIR</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">add_executable</span>(<span style="color:#0ff;font-weight:bold">SafeIntAdd</span> ${SOURCE_DIR})<span style="color:#f00">
</span></code></pre></div><p>相比于构建单个文件，我们额外使用了两个指令：</p>
<ol>
<li>include_directories：添加多个头文件搜索路径，路径之间用空格分隔；如果将 lib 和 definition 目录都添加到到搜索路径的话，在 include 的时候就不需要使用相对路径了</li>
<li>aux_source_directory：在目录中查找所有源文件，并将这些源文件存储在变量 SOURCE_DIR 中；需要注意这个指令不会递归包含子目录</li>
</ol>
<p>接下来进入 build 目录进行构建：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf *
[joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ..
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style="color:#fff;font-weight:bold">done</span>
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style="color:#fff;font-weight:bold">done</span>
-- Configuring <span style="color:#fff;font-weight:bold">done</span>
-- Generating <span style="color:#fff;font-weight:bold">done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
[joelzychen@DevCloud ~/cmake-tutorial/build]$ make
Scanning dependencies of target SafeIntAdd
[ 50%] Building CXX object CMakeFiles/SafeIntAdd.dir/main.cc.o
[100%] Linking CXX executable SafeIntAdd
[100%] Built target SafeIntAdd
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ./SafeIntAdd 
<span style="color:#ff0;font-weight:bold">2000000000</span> <span style="color:#ff0;font-weight:bold">1900000000</span>
<span style="color:#ff0;font-weight:bold">2147483647</span>
</code></pre></div><h2 id="3-构建依赖于静态库的项目">3. 构建依赖于静态库的项目</h2>
<p>关于静态库和动态库相关内容可以参考<a href="https://zhuanlan.zhihu.com/p/71372182">浅谈静态库和动态库</a>。</p>
<h3 id="31-使用-gcc-编译静态库文件">3.1 使用 GCC 编译静态库文件</h3>
<p>假设现在我们希望将 exp2 函数封装到一个计算器单例类中，并计算 2 的 n 次方，并为此编写了以下这些文件：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007f7f">// main.cc
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;util/calculator.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;definition/error_code.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;iostream&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">int</span> main()
{
    <span style="color:#fff;font-weight:bold">double</span> a{ <span style="color:#ff0;font-weight:bold">0</span> };
    std::cin &gt;&gt; a;
    <span style="color:#fff;font-weight:bold">double</span> exp2{ <span style="color:#ff0;font-weight:bold">0</span> };
    <span style="color:#fff;font-weight:bold">int</span> ret_val = Calculator::GetInstance().Exp2(exp2, a);
    <span style="color:#fff;font-weight:bold">if</span> (ret_val != exit_success)
    {
        <span style="color:#fff;font-weight:bold">return</span> ret_val;
    }
    std::cout &lt;&lt; exp2 &lt;&lt; std::endl;
    <span style="color:#fff;font-weight:bold">return</span> exit_success;
}

</code></pre></div><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007f7f">// util/singleton.h
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#ifndef UTIL_SINGLETON_H
</span><span style="color:#0f0;font-weight:bold">#define UTIL_SINGLETON_H
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">template</span> &lt;<span style="color:#fff;font-weight:bold">typename</span> T&gt;
<span style="color:#fff;font-weight:bold">class</span> Singleton
{
<span style="color:#fff;font-weight:bold">public</span>:
    <span style="color:#fff;font-weight:bold">static</span> T&amp; GetInstance()
    {
        <span style="color:#fff;font-weight:bold">static</span> T instance;
        <span style="color:#fff;font-weight:bold">return</span> instance;
    }
    Singleton(Singleton <span style="color:#fff;font-weight:bold">const</span> &amp;) = <span style="color:#fff;font-weight:bold">delete</span>;
    Singleton&amp; <span style="color:#fff;font-weight:bold">operator</span>=(Singleton <span style="color:#fff;font-weight:bold">const</span> &amp;) = <span style="color:#fff;font-weight:bold">delete</span>;

<span style="color:#fff;font-weight:bold">protected</span>:
    Singleton() = <span style="color:#fff;font-weight:bold">default</span>;
    ~Singleton() = <span style="color:#fff;font-weight:bold">default</span>;

};

<span style="color:#0f0;font-weight:bold">#endif
</span></code></pre></div><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cpp" data-lang="cpp"><span style="color:#007f7f">// definition/error_code.h
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#ifndef DEFINITION_ERROR_CODE_H
</span><span style="color:#0f0;font-weight:bold">#define DEFINITION_ERROR_CODE_H
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">constexpr</span> <span style="color:#fff;font-weight:bold">int</span> exit_success = <span style="color:#ff0;font-weight:bold">0</span>;
<span style="color:#fff;font-weight:bold">constexpr</span> <span style="color:#fff;font-weight:bold">int</span> exit_failure = <span style="color:#ff0;font-weight:bold">1</span>;
<span style="color:#fff;font-weight:bold">constexpr</span> <span style="color:#fff;font-weight:bold">int</span> error_data_overflow = <span style="color:#ff0;font-weight:bold">2</span>;

<span style="color:#0f0;font-weight:bold">#endif
</span></code></pre></div><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007f7f">// util/calculator.h
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#ifndef UTIL_CALCULATOR_H
</span><span style="color:#0f0;font-weight:bold">#define UTIL_CALCULATOR_H
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;singleton.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;../definition/error_code.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;limits&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&lt;cmath&gt;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">class</span> Calculator : <span style="color:#fff;font-weight:bold">public</span> Singleton&lt;Calculator&gt;
{
<span style="color:#fff;font-weight:bold">public</span>:
    <span style="color:#fff;font-weight:bold">template</span>&lt;<span style="color:#fff;font-weight:bold">typename</span> ValueType&gt;
    ValueType ValueTypeMax(ValueType)
    {
        <span style="color:#fff;font-weight:bold">return</span> std::numeric_limits&lt;ValueType&gt;::max();
    }

    <span style="color:#fff;font-weight:bold">int</span> Exp2(<span style="color:#fff;font-weight:bold">double</span> &amp;exp2, <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">double</span> &amp;val);
};

<span style="color:#0f0;font-weight:bold">#endif
</span></code></pre></div><p>为了方便生成静态库文件，我们先将 calculator.cc 这个文件放到 archive 目录下：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#007f7f">// archive/calculator.cc
</span><span style="color:#007f7f"></span><span style="color:#0f0;font-weight:bold">#include</span> <span style="color:#0f0;font-weight:bold">&#34;../util/calculator.h&#34;</span><span style="color:#0f0;font-weight:bold">
</span><span style="color:#0f0;font-weight:bold"></span>
<span style="color:#fff;font-weight:bold">int</span> Calculator::Exp2(<span style="color:#fff;font-weight:bold">double</span> &amp;exp2, <span style="color:#fff;font-weight:bold">const</span> <span style="color:#fff;font-weight:bold">double</span> &amp;val)
{
    <span style="color:#fff;font-weight:bold">if</span> (std::sqrt(ValueTypeMax(val)) &lt; val)
    {
        exp2 = ValueTypeMax(val);
        <span style="color:#fff;font-weight:bold">return</span> error_data_overflow;
    }
    exp2 = std::exp2(val);
    <span style="color:#fff;font-weight:bold">return</span> exit_success;
}

</code></pre></div><p>对于 calculator.cc 这个源文件，我们可以使用 -c 参数将其编译为 obj 文件，再使用 ar 归档就能将其编译为一个 .a 库文件了：：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial/archive]$ g++ calculator.cc -g -Wall -std=c++11 -c
[joelzychen@DevCloud ~/cmake-tutorial/archive]$ ar -crv libcalculator.a calculator.o
a - calculator.o
</code></pre></div><h3 id="32-使用-gcc-编译项目和链接静态库">3.2 使用 GCC 编译项目和链接静态库</h3>
<p>现在的目录结构如下：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial]$ tree
.
|-- archive
|   |-- calculator.cc
|   |-- calculator.o
|   <span style="color:#0ff;font-weight:bold">`</span>-- libcalculator.a
|-- CMakeLists.txt
|-- definition
|   <span style="color:#0ff;font-weight:bold">`</span>-- error_code.h
|-- main.cc
<span style="color:#0ff;font-weight:bold">`</span>-- util
    |-- calculator.h
    <span style="color:#0ff;font-weight:bold">`</span>-- singleton.h

<span style="color:#ff0;font-weight:bold">3</span> directories, <span style="color:#ff0;font-weight:bold">8</span> files
</code></pre></div><p>使用 GCC 编译和链接到对应的静态库文件即可得到可执行文件：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial]$ g++ main.cc -g -Wall -std=c++11 -o Exp2 -Larchive -lcalculator
[joelzychen@DevCloud ~/cmake-tutorial]$ ll Exp2 
32K -rwxrwxr-x <span style="color:#ff0;font-weight:bold">1</span> joelzychen joelzychen 31K Jun <span style="color:#ff0;font-weight:bold">21</span> 14:38 Exp2
[joelzychen@DevCloud ~/cmake-tutorial]$ ./Exp2
<span style="color:#ff0;font-weight:bold">8</span>
<span style="color:#ff0;font-weight:bold">256</span>
</code></pre></div><p>需要注意的点有：</p>
<ol>
<li>-Llib 用于指定库文件目录</li>
<li>-lsingleton 用于指定库文件</li>
<li>-L 和 -l 参数一定要在 -o 参数之后</li>
</ol>
<h3 id="33-使用-cmake-构建项目和链接静态库">3.3 使用 cmake 构建项目和链接静态库</h3>
<p>我们刚才已经用 GCC 编译好了静态库文件，所以可以直接在 CMakeLists.txt 里添加链接静态库的指令：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#fff;font-weight:bold">cmake_minimum_required</span>(<span style="color:#0ff;font-weight:bold">VERSION</span> <span style="color:#0ff;font-weight:bold">3.10</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">project</span>(<span style="color:#0ff;font-weight:bold">Exp2</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_COMPILER</span> <span style="color:#0ff;font-weight:bold">&#34;c++&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD</span> <span style="color:#0ff;font-weight:bold">11</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#0ff;font-weight:bold">True</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">-g</span> <span style="color:#0ff;font-weight:bold">-Wall</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">string</span>(<span style="color:#0ff;font-weight:bold">REPLACE</span> <span style="color:#0ff;font-weight:bold">&#34;;&#34;</span> <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> <span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span style="color:#0ff;font-weight:bold">bin/</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;source dir: &#34;</span> ${PROJECT_SOURCE_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;binary dir: &#34;</span> ${PROJECT_BINARY_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;output dir: &#34;</span> ${CMAKE_RUNTIME_OUTPUT_DIRECTORY})<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">include_directories</span>(<span style="color:#0ff;font-weight:bold">./</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">aux_source_directory</span>(<span style="color:#0ff;font-weight:bold">./</span> <span style="color:#0ff;font-weight:bold">SOURCE_DIR</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">link_directories</span>(<span style="color:#0ff;font-weight:bold">archive/</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">add_executable</span>(<span style="color:#0ff;font-weight:bold">Exp2</span> ${SOURCE_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">target_link_libraries</span>(<span style="color:#0ff;font-weight:bold">Exp2</span> <span style="color:#0ff;font-weight:bold">libcalculator.a</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#007f7f"># target_link_libraries(Exp2 calculator)
</span></code></pre></div><p>和之前相比，额外使用的指令有：</p>
<ol>
<li>link_directories：指定静态库或动态库的搜索路径</li>
<li>target_link_libraries：将指定的静态库连接到可执行文件上，singleton 和 libsingleton.a 两种形式等价</li>
</ol>
<p>然后进入 build 目录进行构建：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf *
[joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ../
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style="color:#fff;font-weight:bold">done</span>
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style="color:#fff;font-weight:bold">done</span>
-- <span style="color:#fff;font-weight:bold">source</span> dir: /home/joelzychen/cmake-tutorial
-- binary dir: /home/joelzychen/cmake-tutorial/build
-- output dir: /home/joelzychen/cmake-tutorial/build/bin/
-- Configuring <span style="color:#fff;font-weight:bold">done</span>
-- Generating <span style="color:#fff;font-weight:bold">done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
[joelzychen@DevCloud ~/cmake-tutorial/build]$ make
Scanning dependencies of target Exp2
[ 50%] Building CXX object CMakeFiles/Exp2.dir/main.cc.o
[100%] Linking CXX executable bin/Exp2
[100%] Built target Exp2
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ll bin/Exp2 
32K -rwxrwxr-x <span style="color:#ff0;font-weight:bold">1</span> joelzychen joelzychen 31K Jun <span style="color:#ff0;font-weight:bold">21</span> 14:58 bin/Exp2
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ./bin/Exp2 
<span style="color:#ff0;font-weight:bold">6</span>
<span style="color:#ff0;font-weight:bold">64</span>
</code></pre></div><p>可以看到通过 cmake 构建得到二进制文件大小和直接通过 GCC 编译和链接得到的二进制文件大小是相同的。这次用 <code>set(CMAKE_RUNTIME_OUTPUT_DIRECTORY bin/)</code> 命令将生成的二进制文件放到了 bin 目录下，注意这里的 bin 目录是使用 cmake 进行构建的目录（PROJECT_BINARY_DIR），不是 CMakeLists.txt 所在的目录（PROJECT_SOURCE_DIR）。</p>
<h3 id="34-使用-cmake-构建静态库文件和项目">3.4 使用 cmake 构建静态库文件和项目</h3>
<p>除了直接引用外部的静态库，cmake 还可以先将源文件编译成静态库之后在进行构建：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#fff;font-weight:bold">cmake_minimum_required</span>(<span style="color:#0ff;font-weight:bold">VERSION</span> <span style="color:#0ff;font-weight:bold">3.10</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">project_name</span> <span style="color:#0ff;font-weight:bold">Exp2</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">project</span>(${project_name})<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_COMPILER</span> <span style="color:#0ff;font-weight:bold">&#34;c++&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD</span> <span style="color:#0ff;font-weight:bold">11</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#0ff;font-weight:bold">True</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">-g</span> <span style="color:#0ff;font-weight:bold">-Wall</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">string</span>(<span style="color:#0ff;font-weight:bold">REPLACE</span> <span style="color:#0ff;font-weight:bold">&#34;;&#34;</span> <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> <span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span style="color:#0ff;font-weight:bold">bin/</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;source dir: &#34;</span> ${PROJECT_SOURCE_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;binary dir: &#34;</span> ${PROJECT_BINARY_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;output dir: &#34;</span> <span style="color:#0ff;font-weight:bold">&#34;${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">include_directories</span>(<span style="color:#0ff;font-weight:bold">./</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">aux_source_directory</span>(<span style="color:#0ff;font-weight:bold">./</span> <span style="color:#0ff;font-weight:bold">SOURCE_DIR</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">static_lib_source_file</span> <span style="color:#0ff;font-weight:bold">archive/calculator.cc</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">add_library</span>(<span style="color:#0ff;font-weight:bold">calculator_static</span> <span style="color:#0ff;font-weight:bold">STATIC</span> ${static_lib_source_file})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">add_executable</span>(${project_name} ${SOURCE_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">target_link_libraries</span>(${project_name} <span style="color:#0ff;font-weight:bold">calculator_static</span>)<span style="color:#f00">
</span></code></pre></div><p>这里用到了一个新的指令 <a href="https://cmake.org/cmake/help/latest/command/add_library.html?highlight=add_library">add_library</a> 来使用指定的源文件生成库文件，再使用 target_link_libraries 将生成的库文件添加到项目中；接下来进行构建：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf *
[joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ../
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style="color:#fff;font-weight:bold">done</span>
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style="color:#fff;font-weight:bold">done</span>
-- <span style="color:#fff;font-weight:bold">source</span> dir: /home/joelzychen/cmake-tutorial
-- binary dir: /home/joelzychen/cmake-tutorial/build
-- output dir: /home/joelzychen/cmake-tutorial/build/bin/
-- Configuring <span style="color:#fff;font-weight:bold">done</span>
-- Generating <span style="color:#fff;font-weight:bold">done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
[joelzychen@DevCloud ~/cmake-tutorial/build]$ make
Scanning dependencies of target calculator_static
[ 25%] Building CXX object CMakeFiles/calculator_static.dir/archive/calculator.cc.o
[ 50%] Linking CXX static library libcalculator_static.a
[ 50%] Built target calculator_static
Scanning dependencies of target Exp2
[ 75%] Building CXX object CMakeFiles/Exp2.dir/main.cc.o
[100%] Linking CXX executable bin/Exp2
[100%] Built target Exp2
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ll | grep calculator
 12K -rw-rw-r-- <span style="color:#ff0;font-weight:bold">1</span> joelzychen joelzychen  11K Jun <span style="color:#ff0;font-weight:bold">21</span> 15:30 libcalculator_static.a
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ./bin/Exp2 
<span style="color:#ff0;font-weight:bold">5</span>
<span style="color:#ff0;font-weight:bold">32</span>
</code></pre></div><p>可以看到在 build 目录下生成了一个名为 libcalculator_static.a 的静态库文件，这个名字是由使用 add_library 指令时的第一个参数指定的。</p>
<h2 id="4-构建依赖于动态库的项目">4. 构建依赖于动态库的项目</h2>
<h3 id="41-使用-gcc-编译动态库文件">4.1 使用 GCC 编译动态库文件</h3>
<p>仍然使用之前已有的文件，在 archive 目录下生成动态库文件：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial/archive]$ rm calculator.o libcalculator.a
[joelzychen@DevCloud ~/cmake-tutorial/archive]$ g++ calculator.cc -g -Wall -std=c++11 -c -fPIC
[joelzychen@DevCloud ~/cmake-tutorial/archive]$ g++ calculator.o -g -Wall -std=c++11 -shared -o libcalculator.so
</code></pre></div><p>分为两个步骤：</p>
<ol>
<li>使用 -c 和 -fPIC 参数生成位置无关的（position independent code）机器码 .o 文件</li>
<li>使用 -shared 参数生成 .so 动态库文件</li>
</ol>
<p>也可以合并为一个步骤：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial/archive]$ g++ calculator.cc -g -Wall -std=c++11 -shared -fPIC -o libcalculator.so
</code></pre></div><p>这样可以直接生成动态库文件，省去生成机器码文件的中间步骤。</p>
<h3 id="42-使用-gcc-编译项目和链接动态库">4.2 使用 GCC 编译项目和链接动态库</h3>
<p>和链接到静态库类似，在编译后链接动态库即可生成二进制文件：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial]$ g++ main.cc -g -Wall -std=c++11 -o Exp2 -Larchive -lcalculator
[joelzychen@DevCloud ~/cmake-tutorial]$ ./Exp2 
./Exp2: error <span style="color:#fff;font-weight:bold">while</span> loading shared libraries: libcalculator.so: cannot open shared object file: No such file or directory
</code></pre></div><p>我们发现在运行二级制文件时会出现找不到动态库的报错，这是因为动态链接库环境变量的目录下没有找到编译时所用到的动态库，我们可以将对应的目录添加到环境变量下，或是将动态库拷贝到环境变量的目录下：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial]$ <span style="color:#fff;font-weight:bold">echo</span> $LD_LIBRARY_PATH

[joelzychen@DevCloud ~/cmake-tutorial]$ <span style="color:#fff;font-weight:bold">export</span> LD_LIBRARY_PATH=<span style="color:#0ff;font-weight:bold">&#34;/usr/lib/&#34;</span>
[joelzychen@DevCloud ~/cmake-tutorial]$ sudo cp archive/libcalculator.so /usr/lib/
</code></pre></div><p>接下来就可以运行可执行文件了，可以看到使用链接动态库方式生成的可执行文件的大小要小于使用链接静态库方式生成的可执行文件，使用 ldd 命令也能看到可执行文件是正确地调用了对应的动态库文件：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial]$ ./Exp2 
<span style="color:#ff0;font-weight:bold">9</span>
<span style="color:#ff0;font-weight:bold">512</span>
[joelzychen@DevCloud ~/cmake-tutorial]$ ll Exp2 
28K -rwxrwxr-x <span style="color:#ff0;font-weight:bold">1</span> joelzychen joelzychen 28K Jun <span style="color:#ff0;font-weight:bold">21</span> 14:25 Exp2
[joelzychen@DevCloud ~/cmake-tutorial]$ ldd Exp2 | grep calculator
        libcalculator.so =&gt; /usr/lib/libcalculator.so (0x00007fd2391f0000)
</code></pre></div><h3 id="43-使用-cmake-构建项目和链接动态库">4.3 使用 cmake 构建项目和链接动态库</h3>
<p>和构建静态库类似，只需要将 CMakeLists.txt 中链接静态库的指令修改为链接动态库即可进行构建：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#fff;font-weight:bold">cmake_minimum_required</span>(<span style="color:#0ff;font-weight:bold">VERSION</span> <span style="color:#0ff;font-weight:bold">3.10</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">project</span>(<span style="color:#0ff;font-weight:bold">Exp2</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_COMPILER</span> <span style="color:#0ff;font-weight:bold">&#34;c++&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD</span> <span style="color:#0ff;font-weight:bold">11</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#0ff;font-weight:bold">True</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">-g</span> <span style="color:#0ff;font-weight:bold">-Wall</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">string</span>(<span style="color:#0ff;font-weight:bold">REPLACE</span> <span style="color:#0ff;font-weight:bold">&#34;;&#34;</span> <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> <span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span style="color:#0ff;font-weight:bold">bin/</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;source dir: &#34;</span> ${PROJECT_SOURCE_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;binary dir: &#34;</span> ${PROJECT_BINARY_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;output dir: &#34;</span> <span style="color:#0ff;font-weight:bold">&#34;${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">include_directories</span>(<span style="color:#0ff;font-weight:bold">./</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">aux_source_directory</span>(<span style="color:#0ff;font-weight:bold">./</span> <span style="color:#0ff;font-weight:bold">SOURCE_DIR</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">link_directories</span>(<span style="color:#0ff;font-weight:bold">archive/</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">add_executable</span>(<span style="color:#0ff;font-weight:bold">Exp2</span> ${SOURCE_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">target_link_libraries</span>(<span style="color:#0ff;font-weight:bold">Exp2</span> <span style="color:#0ff;font-weight:bold">libcalculator.so</span>)<span style="color:#f00">
</span></code></pre></div><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf *
[joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ../
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style="color:#fff;font-weight:bold">done</span>
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style="color:#fff;font-weight:bold">done</span>
-- <span style="color:#fff;font-weight:bold">source</span> dir: /home/joelzychen/cmake-tutorial
-- binary dir: /home/joelzychen/cmake-tutorial/build
-- output dir: /home/joelzychen/cmake-tutorial/build/bin/
-- Configuring <span style="color:#fff;font-weight:bold">done</span>
-- Generating <span style="color:#fff;font-weight:bold">done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
[joelzychen@DevCloud ~/cmake-tutorial/build]$ make
Scanning dependencies of target Exp2
[ 50%] Building CXX object CMakeFiles/Exp2.dir/main.cc.o
[100%] Linking CXX executable bin/Exp2
[100%] Built target Exp2
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ll bin/Exp2 
28K -rwxrwxr-x <span style="color:#ff0;font-weight:bold">1</span> joelzychen joelzychen 28K Jun <span style="color:#ff0;font-weight:bold">21</span> 15:04 bin/Exp2
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ldd bin/Exp2 | grep calculator
        libcalculator.so =&gt; /home/joelzychen/cmake-tutorial/archive/libcalculator.so (0x00007f4c87e35000)
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ./bin/Exp2 
<span style="color:#ff0;font-weight:bold">6</span>
<span style="color:#ff0;font-weight:bold">64</span>
</code></pre></div><p>可以看到通过 cmake 构建得到二进制文件大小和直接通过 GCC 编译和链接动态库得到的二进制文件大小也是相同的。</p>
<h3 id="44-使用-cmake-构建动态库文件和项目">4.4 使用 cmake 构建动态库文件和项目</h3>
<p>使用 cmake 构建动态库的步骤和构建静态库的步骤几乎一模一样，只需要将 add_library 的 STATIC 参数改为 SHARED 即可：</p>
<div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-cmake" data-lang="cmake"><span style="color:#fff;font-weight:bold">cmake_minimum_required</span>(<span style="color:#0ff;font-weight:bold">VERSION</span> <span style="color:#0ff;font-weight:bold">3.10</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">project_name</span> <span style="color:#0ff;font-weight:bold">Exp2</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">project</span>(${project_name})<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_COMPILER</span> <span style="color:#0ff;font-weight:bold">&#34;c++&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD</span> <span style="color:#0ff;font-weight:bold">11</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_STANDARD_REQUIRED</span> <span style="color:#0ff;font-weight:bold">True</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">-g</span> <span style="color:#0ff;font-weight:bold">-Wall</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">string</span>(<span style="color:#0ff;font-weight:bold">REPLACE</span> <span style="color:#0ff;font-weight:bold">&#34;;&#34;</span> <span style="color:#0ff;font-weight:bold">&#34; &#34;</span> <span style="color:#0ff;font-weight:bold">CMAKE_CXX_FLAGS</span> <span style="color:#0ff;font-weight:bold">&#34;${CMAKE_CXX_FLAGS}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">CMAKE_RUNTIME_OUTPUT_DIRECTORY</span> <span style="color:#0ff;font-weight:bold">bin/</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;source dir: &#34;</span> ${PROJECT_SOURCE_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;binary dir: &#34;</span> ${PROJECT_BINARY_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">message</span>(<span style="color:#0ff;font-weight:bold">STATUS</span> <span style="color:#0ff;font-weight:bold">&#34;output dir: &#34;</span> <span style="color:#0ff;font-weight:bold">&#34;${PROJECT_BINARY_DIR}/${CMAKE_RUNTIME_OUTPUT_DIRECTORY}&#34;</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">include_directories</span>(<span style="color:#0ff;font-weight:bold">./</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">aux_source_directory</span>(<span style="color:#0ff;font-weight:bold">./</span> <span style="color:#0ff;font-weight:bold">SOURCE_DIR</span>)<span style="color:#f00">
</span><span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">set</span>(<span style="color:#0ff;font-weight:bold">shared_lib_source_file</span> <span style="color:#0ff;font-weight:bold">archive/calculator.cc</span>)<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">add_library</span>(<span style="color:#0ff;font-weight:bold">calculator_shared</span> <span style="color:#0ff;font-weight:bold">SHARED</span> ${shared_lib_source_file})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">add_executable</span>(${project_name} ${SOURCE_DIR})<span style="color:#f00">
</span><span style="color:#f00"></span><span style="color:#fff;font-weight:bold">target_link_libraries</span>(${project_name} <span style="color:#0ff;font-weight:bold">calculator_shared</span>)<span style="color:#f00">
</span></code></pre></div><div class="highlight"><pre style="color:#e5e5e5;background-color:#000;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">[joelzychen@DevCloud ~/cmake-tutorial/build]$ rm -rf *
[joelzychen@DevCloud ~/cmake-tutorial/build]$ cmake ..
-- The C compiler identification is GNU 4.8.5
-- The CXX compiler identification is GNU 4.8.5
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc
-- Check <span style="color:#fff;font-weight:bold">for</span> working C compiler: /usr/bin/cc - works
-- Detecting C compiler ABI info
-- Detecting C compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting C compile features
-- Detecting C compile features - <span style="color:#fff;font-weight:bold">done</span>
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++
-- Check <span style="color:#fff;font-weight:bold">for</span> working CXX compiler: /usr/bin/c++ - works
-- Detecting CXX compiler ABI info
-- Detecting CXX compiler ABI info - <span style="color:#fff;font-weight:bold">done</span>
-- Detecting CXX compile features
-- Detecting CXX compile features - <span style="color:#fff;font-weight:bold">done</span>
-- <span style="color:#fff;font-weight:bold">source</span> dir: /home/joelzychen/cmake-tutorial
-- binary dir: /home/joelzychen/cmake-tutorial/build
-- output dir: /home/joelzychen/cmake-tutorial/build/bin/
-- Configuring <span style="color:#fff;font-weight:bold">done</span>
-- Generating <span style="color:#fff;font-weight:bold">done</span>
-- Build files have been written to: /home/joelzychen/cmake-tutorial/build
[joelzychen@DevCloud ~/cmake-tutorial/build]$ make
Scanning dependencies of target calculator_shared
[ 25%] Building CXX object CMakeFiles/calculator_shared.dir/archive/calculator.cc.o
[ 50%] Linking CXX shared library libcalculator_shared.so
[ 50%] Built target calculator_shared
Scanning dependencies of target Exp2
[ 75%] Building CXX object CMakeFiles/Exp2.dir/main.cc.o
[100%] Linking CXX executable bin/Exp2
[100%] Built target Exp2
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ll | grep calculator
 16K -rwxrwxr-x <span style="color:#ff0;font-weight:bold">1</span> joelzychen joelzychen  13K Jun <span style="color:#ff0;font-weight:bold">21</span> 15:34 libcalculator_shared.so
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ll bin/Exp2 
28K -rwxrwxr-x <span style="color:#ff0;font-weight:bold">1</span> joelzychen joelzychen 28K Jun <span style="color:#ff0;font-weight:bold">21</span> 15:34 bin/Exp2
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ldd bin/Exp2 | grep calculator
        libcalculator_shared.so =&gt; /home/joelzychen/cmake-tutorial/build/libcalculator_shared.so (0x00007f1fa5aa5000)
[joelzychen@DevCloud ~/cmake-tutorial/build]$ ./bin/Exp2 
<span style="color:#ff0;font-weight:bold">7</span>
<span style="color:#ff0;font-weight:bold">128</span>
</code></pre></div><p>可以看到得到的二进制文件的相关信息和使用前几种方法得到的都是相同的。</p>
<h2 id="5-常用命令">5. 常用命令</h2>
<h3 id="51-项目相关">5.1 项目相关</h3>
<ul>
<li>cmake_minimum_required(VERSION 3.10)：指定 cmake 的最低版本要求</li>
<li>project(project_name)：指定项目的名称</li>
<li>set(CMAKE_CXX_FLAGS -g -Wall -pthread)：设置普通变量，缓存变量或环境变量</li>
</ul>
<h3 id="52-编译相关">5.2 编译相关</h3>
<ul>
<li>include_directories：指定头文件的目录，类似于 GCC 编译时的 <code>-I</code> 参数；等价于将头文件目录添加到环境变量 CPLUS_INCLUDE_PATH 中</li>
<li>aux_source_directory：在目录中（不含子目录）查找所有源文件，并将这些源文件存储在变量 SOURCE_DIR 中</li>
<li>add_executable：使用列出的源文件构建可执行文件</li>
<li>add_definitions：宏定义</li>
</ul>
<h3 id="53-链接相关">5.3 链接相关</h3>
<ul>
<li>link_directories：指定库文件的目录，类似于 GCC 链接时的 <code>-L</code> 参数；等价于将库文件目录添加到环境变量 LD_LIBRARY_PATH 中</li>
<li>target_link_libraries：将指定的静态库连接到可执行文件上，singleton 和 libsingleton.a 两种形式等价</li>
</ul>
<h2 id="6-总结">6. 总结</h2>
<p>本文通过几个示例程序对比了在 Linux 下使用 GCC 和 cmake 来编译和构建程序的基本步骤，了解了一些 cmake 的基础指令。实际开发中的项目往往会非常大，以致于不能够直接使用 GCC 来编译整个项目，在这种场景下使用 cmake 进行构建往往能够节省时间和提高效率，让我们能够专注在项目的开发上。在实际应用中编写 CMakeLists.txt 的时候还会遇到非常多的问题、不熟悉的指令和其他的使用技巧，这些都需要结合<a href="https://cmake.org/cmake/help/latest/index.html">教程</a>和实践来进一步学习。</p>

      </div>

      <footer>
        


        <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "zintrulcre" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      </footer>
    </article>

    
  </section>

      </div>

      <footer class="footer">
  <section class="container">
    
    
    
    
      
      <a href="https://github.com/luizdepra/hugo-coder/tree/"></a>
    
  </section>
</footer>

<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.2/MathJax.js?config=TeX-MML-AM_SVG"></script>
    </main>

    
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
	(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
	})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
	ga('create', 'UA-132809676-1', 'auto');
	
	ga('send', 'pageview');
}
</script>


  </body>

</html>
